language: generic
dist: trusty
services: docker
sudo: false
os: linux
matrix:
  include:
    - name: x86_64-linux
    - name: aarch64-linux
      sudo: required
      env:
        - ARCH=arm64
    - name: armv7l-linux
      sudo: required
      env:
        - ARCH=armhf
    - name: i386-linux-simple
      sudo: required
      env:
        - BUILD_TYPE="arch-simple"
        - ARCH=i386
    - name: aarch64-linux-simple
      sudo: required
      env:
        - BUILD_TYPE="arch-simple"
        - ARCH=arm64
    - name: armv7l-linux-simple
      sudo: required
      env:
        - BUILD_TYPE="arch-simple"
        - ARCH=armhf
    - name: ppc64le-linux-simple
      sudo: required
      env:
        - BUILD_TYPE="arch-simple"
        - ARCH=ppc64el
      # You can run non-important job only for cron mode
      # or any specific environment variable (ex: CI_CRON: 1) is set.
      if: type = cron OR env(CI_CRON) = 1
install:
  - "echo BUILD_TYPE=${BUILD_TYPE} ARCH=${ARCH}"
  # Prepare QEMU.
  # https://github.com/multiarch/qemu-user-static
  # https://hub.docker.com/r/multiarch/ubuntu-debootstrap/tags/
  - |
    if [ "${ARCH}" != "" ]; then
      docker run --rm --privileged multiarch/qemu-user-static:register --reset
    fi
  # Build container image.
  - |
    if [ "${ARCH}" != "" ]; then
      if [ "${BUILD_TYPE}" = "" ]; then
        sed -i "/^FROM / s/arm64/${ARCH}/" Dockerfile && \
          docker build --rm -t sample .
      fi
    fi
before_script:
  # Show environment.
  - uname -a
  - id
  - pwd
script:
  - |
    if [ "${ARCH}" != "" ]; then
      if [ "${BUILD_TYPE}" = "" ]; then
        docker run --rm -t sample ./sample_test.sh
      fi
    fi
  - |
    if [ "${ARCH}" != "" ]; then
      if [ "${BUILD_TYPE}" = "arch-simple" ]; then
        docker run --rm -t multiarch/ubuntu-debootstrap:${ARCH}-bionic uname -a
      fi
    fi
  - |
    if [ "${ARCH}" = "" ]; then
      ./sample_test.sh
    fi
branches:
  only:
    - master
